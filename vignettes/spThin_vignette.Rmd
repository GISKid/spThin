---
title: "spThin Tutorial"
author: "Matthew E. Aiello-Lammens & Jeffrey O. Hanson"
date: "2015-07-16"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::knitr}
  %\VignetteIndexEntry{spThin}
---

# Introduction

The `spThin` package contains functions for spatially thinning and filtering occurrence records. Here we provide a tutorial on how `spThin` can be used to process datasets for environmental niche modelling.

## Load the `spThin` R package

First we will install the R package from source and load it into the workspace.

```{r load_package}

# install package from source
install.packages(type = "source", pkgs = "spThin_0.1.1.tar.gz", repos = NULL )

# load package into workspace
library(spThin)

```

## Example dataset

To demonstrate the use of `spThin` we will use a dataset containing 201 verified, georeferenced occurrence records for the Caribbean spiny pocket mouse (*Heteromys anomalus*). These occurrences are from Columbia, Venezuela, and three Caribbean islands: Trinidad, Tobago, and Margarita. This dataset is included as part of the `spThin` package.

```{r}

## load the dataset
data(Heteromys_anomalus_South_America)

## print first 6
head(Heteromys_anomalus_South_America)
```

The dataset is stored in the variable `Heteromys_anomalus_South_America`. Each row represents a different record. The `LONG` and `LAT` columns contain the longitude and latitude of each record. The `REGION` column denotes where the record was collected, with values corresponding to the the mainland or the names of the three islands. There are many more occurrence records from mainland than for the islands.

```{r}

## number of records in each region
table(Heteromys_anomalus_South_America$REGION)

```
# Thin the full dataset

The function used to thin datasets is `spThin`.  Here, we will generate 100 thinned datasets from the full dataset, each with a minimum distance of 10Km between them. Because the records' coordinates are in longitude and latitude, we will use great circle distances to calculate the distance between each record.

```{r} 
full.thin <- spThin(
	Heteromys_anomalus_South_America, 
	lat.col = "LAT",
	lon.col = "LONG", 
	min.dist = 10000,
	reps = 100,
	great.circle.distance=TRUE
)
```

To visually assess whether we are using enough `reps` to approach the optimal number we use the `plot` method. This function produces four plots:
1. the cumulative number of records retained versus the number of repetitions; 2. the log-log version of the previous plot;
3. a histogram of the maximum number of records retained for each replicate,

```{r}
plot(full.thin)
```

Looking at the plot of cumulative maximum records retained 
versus number of repetitions, we see that in this run, this value
is constant through out the dataset creation process, indicating
that a single repetition would have sufficed to reach 124. This is
likely not always the case, but this plot can be examined to assess
whether a given number of repetitions is sufficient to achieve
a plateau (*sensu* species accumulation curves in Ecology).

# Run `spThin::thin` on datasets separated by region

#### Coastal mainland

```{r} 
thinned_dataset_mainland <-
  thin( loc.data = Heteromys_anomalus_South_America[ which( Heteromys_anomalus_South_America$REGION == "mainland" ) , ], 
        lat.col = "LAT", long.col = "LONG", 
        spec.col = "SPEC", 
        thin.par = 10, reps = 100, 
        locs.thinned.list.return = TRUE, 
        write.files = TRUE, 
        max.files = 5, 
        out.dir = "hanomalus_thinned_mainland/", out.base = "hanomalus_thinned", 
        write.log.file = TRUE,
        log.file = "hanomalus_thinned_mainland_log_file.txt" )
```

### Trinidad

```{r} 
thinned_dataset_trin <-
  thin( loc.data = Heteromys_anomalus_South_America[ which( Heteromys_anomalus_South_America$REGION == "trin" ) , ], 
        lat.col = "LAT", long.col = "LONG", 
        spec.col = "SPEC", 
        thin.par = 10, reps = 10, 
        locs.thinned.list.return = TRUE, 
        write.files = TRUE, 
        max.files = 5, 
        out.dir = "hanomalus_thinned_trin/", out.base = "hanomalus_thinned", 
        write.log.file = TRUE,
        log.file = "hanomalus_thinned_trin_log_file.txt" )
```

### Margarita

```{r} 
thinned_dataset_mar <-
  thin( loc.data = Heteromys_anomalus_South_America[ which( Heteromys_anomalus_South_America$REGION == "mar" ) , ], 
        lat.col = "LAT", long.col = "LONG", 
        spec.col = "SPEC", 
        thin.par = 10, reps = 10, 
        locs.thinned.list.return = TRUE, 
        write.files = TRUE, 
        max.files = 5, 
        out.dir = "hanomalus_thinned_mar/", out.base = "hanomalus_thinned", 
        write.log.file = TRUE,
        log.file = "hanomalus_thinned_mar_log_file.txt" )
```

### Tobago

```{r} 
thinned_dataset_tobago <-
  thin( loc.data = Heteromys_anomalus_South_America[ which( Heteromys_anomalus_South_America$REGION == "tobago" ) , ], 
        lat.col = "LAT", long.col = "LONG", 
        spec.col = "SPEC", 
        thin.par = 10, reps = 10, 
        locs.thinned.list.return = TRUE, 
        write.files = TRUE, 
        max.files = 5, 
        out.dir = "hanomalus_thinned_tobago/", out.base = "hanomalus_thinned", 
        write.log.file = TRUE,
        log.file = "hanomalus_thinned_tobago_log_file.txt" )
```


